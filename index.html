<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blacklist Post Generator </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #f9fafb; /* gray-50 */
            --bg-secondary: #ffffff;
            --text-primary: #1f2937; /* gray-800 */
            --text-secondary: #4b5563; /* gray-600 */
            --text-headings: #111827; /* gray-900 */
            --border-color: #e5e7eb; /* gray-200 */
            --border-dashed: #cbd5e1; /* gray-300 */
            --dynamic-item-bg: #f8fafc;
            --preview-bg: #f3f4f6; /* gray-100 */
            --modal-bg: #fefefe;
            --input-bg: #ffffff;
        }

        html.dark {
            --bg-main: #111827; /* gray-900 */
            --bg-secondary: #1f2937; /* gray-800 */
            --text-primary: #d1d5db; /* gray-300 */
            --text-secondary: #9ca3af; /* gray-400 */
            --text-headings: #f9fafb; /* gray-50 */
            --border-color: #374151; /* gray-700 */
            --border-dashed: #4b5563; /* gray-600 */
            --dynamic-item-bg: #374151; /* gray-700 */
            --preview-bg: #1f2937; /* gray-800 */
            --modal-bg: #1f2937;
            --input-bg: #374151; /* gray-700 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
        }

        .form-section { border: 1px solid var(--border-color); background-color: var(--bg-secondary); }
        .form-section-header { border-bottom: 1px solid var(--border-color); }
        .form-section-header h3 { color: var(--text-headings); }
        .dynamic-item { border: 1px dashed var(--border-dashed); background-color: var(--dynamic-item-bg); }
        .preview-pane { background-color: var(--preview-bg); }
        .modal-content { background-color: var(--modal-bg); }
        input, textarea, select { background-color: var(--input-bg); border-color: var(--border-color); color: var(--text-primary); }
        input::placeholder, textarea::placeholder { color: var(--text-secondary); }
        .form-section, .form-section-header, .form-section-content, .chevron-icon, body { transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        .form-section { border-radius: 0.5rem; margin-bottom: 1.5rem; }
        .form-section-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; cursor: pointer; }
        .form-section-header:focus-visible { outline: 2px solid #3b82f6; outline-offset: 2px; border-radius: 0.5rem; }
        .form-section-header.collapsed { border-bottom-color: transparent; }
        .form-section-header h3 { font-size: 1.125rem; font-weight: 600; }
        .form-section-content { padding: 1.5rem; max-height: 2000px; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; }
        .form-section-content.collapsed { max-height: 0; padding-top: 0; padding-bottom: 0; }
        .chevron-icon { transition: transform 0.3s; }
        .chevron-icon.collapsed { transform: rotate(-90deg); }
        .item-controls { position: absolute; top: 0.5rem; right: 0.5rem; display: flex; gap: 0.25rem; }
        .control-btn { background-color: #64748b; color: white; border: none; border-radius: 9999px; width: 1.75rem; height: 1.75rem; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s, opacity 0.2s; }
        .control-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .control-btn.remove-btn { background-color: #ef4444; }
        .control-btn:not(:disabled):hover { background-color: #475569; }
        .control-btn.remove-btn:not(:disabled):hover { background-color: #dc2626; }
        .preview-pane { white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; }
        .preview-pane a { color: #3b82f6; text-decoration: underline; }
        .preview-pane strong, .preview-pane b { font-weight: bold; }
        .copy-button { transition: all 0.2s ease-in-out; }
        .copy-button:active { transform: scale(0.95); }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { padding: 2rem; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 0.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
        .close-button { color: #aaa; position: absolute; top: 0.5rem; right: 1rem; font-size: 28px; font-weight: bold; cursor: pointer; }
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; font-weight: 500; box-shadow: 0 4px 6px rgba(0,0,0,0.1); opacity: 0; transform: translateX(100%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { background-color: #22c55e; }
        .toast.error { background-color: #ef4444; }
        .toast.info { background-color: #3b82f6; }
        .sticky-header.scrolled { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        html.dark .sticky-header.scrolled { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3); }
        .action-btn { transition: transform 0.1s ease-in-out; }
        .action-btn:active { transform: scale(0.97); }
        .empty-state { color: var(--text-secondary); text-align: center; padding: 1rem; font-style: italic; }
        .image-preview { width: 64px; height: 64px; object-fit: cover; border-radius: 0.25rem; background-color: var(--preview-bg); }
        .char-count-limit-exceeded { color: #ef4444 !important; }
        .modal-list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid var(--border-color); }
        .modal-list-item:hover { background-color: var(--preview-bg); }
        .modal-list-item-text { flex-grow: 1; cursor: pointer; }
        .modal-list-item-controls { display: flex; gap: 0.5rem; }
        .modal-control-btn { background: none; border: none; cursor: pointer; font-size: 1.25rem; padding: 0.25rem; }
        .ai-btn { padding: 0.25rem 0.5rem; font-size: 0.875rem; line-height: 1.25rem; }
        .ai-btn .spinner { display: none; }
        .ai-btn.loading .spinner { display: inline-block; }
        .ai-btn.loading .btn-text { display: none; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; background-color: var(--bg-secondary); min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 0.375rem; border: 1px solid var(--border-color); bottom: 100%; right: 0; margin-bottom: 0.5rem;}
        .dropdown-content a { color: var(--text-primary); padding: 12px 16px; text-decoration: none; display: block; font-size: 0.875rem; }
        .dropdown-content a:hover { background-color: var(--preview-bg); }
        .dropdown.show .dropdown-content { display: block; }

        /* Dark Mode Toggle */
        .theme-switch-wrapper { display: flex; align-items: center; gap: 0.5rem; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; }
        input:checked + .slider { background-color: #4f46e5; }
        input:checked + .slider:before { transform: translateX(24px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
    </style>
</head>
<body class="text-gray-800">

    <div id="toast-container"></div>
    <div id="app-container">
        <div class="container mx-auto p-4 md:p-8">
            <header class="text-center mb-8 relative">
                <h1 class="text-4xl font-bold text-headings">Blacklist Post Generator</h1>
                <p class="text-lg text-secondary mt-2">Create, format, and manage social media alerts with autosave and AI.</p>
                <div class="absolute top-0 right-0 theme-switch-wrapper">
                    <span class="text-sm font-medium text-secondary">‚òÄÔ∏è</span>
                    <label class="theme-switch" for="theme-toggle">
                        <input type="checkbox" id="theme-toggle" />
                        <span class="slider round"></span>
                    </label>
                    <span class="text-sm font-medium text-secondary">üåô</span>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Form Column -->
                <div id="form-column" class="lg:h-screen lg:overflow-y-auto pr-4 pb-16">
                     <div id="sticky-header" class="sticky-header flex flex-col space-y-4 mb-4 sticky top-0 bg-main py-4 z-10 border-b border-border-color transition-shadow duration-300">
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                             <button id="newPost" class="action-btn w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow">New Post</button>
                             <button id="loadPosts" class="action-btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow">Load Posts</button>
                             <button id="loadTemplate" class="action-btn w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg shadow">Templates</button>
                             <button id="saveOrUpdate" class="action-btn w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow">Save</button>
                             <button id="saveAsNew" class="action-btn w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow">Save As...</button>
                        </div>
                        <div id="editingStatus" class="text-center text-sm text-secondary font-semibold h-5" aria-live="polite"></div>
                    </div>

                    <!-- All form sections remain the same -->
                    <div class="form-section shadow-md">
                        <div class="form-section-header" role="button" aria-expanded="true" aria-controls="mainInfoContent" tabindex="0">
                            <h3><span aria-hidden="true" class="text-xl mr-2">‚öñÔ∏è</span>Main Information</h3>
                            <svg class="chevron-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="form-section-content" id="mainInfoContent">
                            <div class="space-y-4">
                                <div><label for="subjectName" class="block text-sm font-medium text-secondary mb-1">Subject's Full Name</label><input type="text" id="subjectName" class="w-full p-2 border rounded-md"></div>
                                <div><label for="caseType" class="block text-sm font-medium text-secondary mb-1">Case Type</label><input type="text" id="caseType" placeholder="e.g., Animal Cruelty Case" class="w-full p-2 border rounded-md"></div>
                                <div><label for="location" class="block text-sm font-medium text-secondary mb-1">Location</label><input type="text" id="location" placeholder="e.g., Puerto Rico" class="w-full p-2 border rounded-md"></div>
                                <div><label for="updateDate" class="block text-sm font-medium text-secondary mb-1">Date of Update</label><input type="date" id="updateDate" class="w-full p-2 border rounded-md"></div>
                                <div><label for="caseUpdate" class="block text-sm font-medium text-secondary mb-1">Key Updates & Orders</label><textarea id="caseUpdate" placeholder="Use '‚ñ™Ô∏é' for bullet points" rows="4" class="w-full p-2 border rounded-md"></textarea></div>
                                <div><label for="trialDate" class="block text-sm font-medium text-secondary mb-1">Trial / Hearing Date</label><input type="text" id="trialDate" class="w-full p-2 border rounded-md"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section shadow-md">
                         <div class="form-section-header" role="button" aria-expanded="true" aria-controls="individualsContent" tabindex="0">
                            <h3><span aria-hidden="true" class="text-xl mr-2">üë§</span>Blacklisted Individuals</h3>
                            <svg class="chevron-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="form-section-content" id="individualsContent">
                            <div id="individualsContainer" class="space-y-4"></div>
                            <button id="addIndividual" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg w-full action-btn">Add Individual</button>
                        </div>
                    </div>

                    <div class="form-section shadow-md">
                         <div class="form-section-header" role="button" aria-expanded="true" aria-controls="aliasesContent" tabindex="0">
                            <h3><span aria-hidden="true" class="text-xl mr-2">üé≠</span>Aliases</h3>
                            <svg class="chevron-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="form-section-content" id="aliasesContent">
                            <div id="aliasesContainer" class="space-y-4"></div>
                            <button id="addAlias" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg w-full action-btn">Add Alias</button>
                        </div>
                    </div>

                    <div class="form-section shadow-md">
                         <div class="form-section-header" role="button" aria-expanded="true" aria-controls="organizationsContent" tabindex="0">
                            <h3><span aria-hidden="true" class="text-xl mr-2">üè¢</span>Associated Organizations</h3>
                            <svg class="chevron-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="form-section-content" id="organizationsContent">
                            <div id="organizationsContainer" class="space-y-4"></div>
                            <button id="addOrganization" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg w-full action-btn">Add Organization/Group</button>
                        </div>
                    </div>

                    <div class="form-section shadow-md">
                         <div class="form-section-header" role="button" aria-expanded="true" aria-controls="legalRegContent" tabindex="0">
                            <h3><span aria-hidden="true" class="text-xl mr-2">‚öñÔ∏è</span>Legal Registration</h3>
                            <svg class="chevron-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="form-section-content" id="legalRegContent">
                            <div id="legalRegistrationsContainer" class="space-y-4"></div>
                            <button id="addLegalRegistration" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg w-full action-btn">Add Legal Document</button>
                        </div>
                    </div>
                    
                    <div class="form-section shadow-md">
                         <div class="form-section-header" role="button" aria-expanded="true" aria-controls="fraudAllegationsContent" tabindex="0">
                            <h3><span aria-hidden="true" class="text-xl mr-2">üí∞</span>Allegations of Fraudulent Solicitations</h3>
                            <svg class="chevron-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="form-section-content" id="fraudAllegationsContent">
                            <div id="fraudulentSolicitationsContainer" class="space-y-4"></div>
                            <button id="addFraudulentSolicitation" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg w-full action-btn">Add Allegation</button>
                        </div>
                    </div>

                    <div class="form-section shadow-md">
                         <div class="form-section-header" role="button" aria-expanded="true" aria-controls="warningsContent" tabindex="0">
                            <h3><span aria-hidden="true" class="text-xl mr-2">‚ö†Ô∏è</span>Warnings and First-Hand Accounts</h3>
                            <svg class="chevron-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="form-section-content" id="warningsContent">
                            <div id="warningsAndAccountsContainer" class="space-y-4"></div>
                            <button id="addWarningAndAccount" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg w-full action-btn">Add Account</button>
                        </div>
                    </div>

                    <div class="form-section shadow-md">
                         <div class="form-section-header" role="button" aria-expanded="true" aria-controls="investigationsContent" tabindex="0">
                            <h3><span aria-hidden="true" class="text-xl mr-2">üïµÔ∏è</span>Animal Cruelty Investigations</h3>
                            <svg class="chevron-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="form-section-content" id="investigationsContent">
                            <div id="investigationsContainer" class="space-y-4"></div>
                            <button id="addInvestigation" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg w-full action-btn">Add Investigation</button>
                        </div>
                    </div>

                    <div class="form-section shadow-md">
                         <div class="form-section-header" role="button" aria-expanded="true" aria-controls="evidenceContent" tabindex="0">
                            <h3><span aria-hidden="true" class="text-xl mr-2">üìÇ</span>Enhanced Documentation & Evidence</h3>
                            <svg class="chevron-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="form-section-content" id="evidenceContent">
                            <div id="evidenceContainer" class="space-y-4"></div>
                            <button id="addEvidence" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg w-full action-btn">Add Evidence</button>
                        </div>
                    </div>

                    <div class="form-section shadow-md">
                         <div class="form-section-header" role="button" aria-expanded="true" aria-controls="articlesContent" tabindex="0">
                            <h3><span aria-hidden="true" class="text-xl mr-2">üì∞</span>News & Legal Documents</h3>
                            <svg class="chevron-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="form-section-content" id="articlesContent">
                            <div id="articlesContainer" class="space-y-4"></div>
                            <button id="addArticle" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg w-full action-btn">Add Article/Document</button>
                        </div>
                    </div>

                     <div class="form-section shadow-md">
                         <div class="form-section-header" role="button" aria-expanded="true" aria-controls="summaryContent" tabindex="0">
                            <h3><span aria-hidden="true" class="text-xl mr-2">üìù</span>Summary & Extra Details</h3>
                            <svg class="chevron-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div class="form-section-content" id="summaryContent">
                             <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <label for="backgroundInfo" class="block text-sm font-medium text-secondary">Background Information</label>
                                        <button id="summarizeBackground" class="ai-btn action-btn text-xs bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-2 rounded-lg shadow">
                                            <span class="btn-text">‚ú® Summarize</span>
                                            <span class="spinner">üåÄ</span>
                                        </button>
                                    </div>
                                    <textarea id="backgroundInfo" rows="6" class="w-full p-2 border rounded-md"></textarea>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <label for="emergingReports" class="block text-sm font-medium text-secondary">Emerging Reports</label>
                                        <button id="expandReports" class="ai-btn action-btn text-xs bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-2 rounded-lg shadow">
                                            <span class="btn-text">‚ú® Expand</span>
                                            <span class="spinner">üåÄ</span>
                                        </button>
                                    </div>
                                    <textarea id="emergingReports" rows="3" class="w-full p-2 border rounded-md"></textarea>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <label for="hashtags" class="block text-sm font-medium text-secondary">Hashtags</label>
                                        <button id="suggestHashtags" class="ai-btn action-btn text-xs bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-2 rounded-lg shadow">
                                            <span class="btn-text">‚ú® Suggest</span>
                                            <span class="spinner">üåÄ</span>
                                        </button>
                                    </div>
                                    <input type="text" id="hashtags" placeholder="#Hashtag1 #Hashtag2" class="w-full p-2 border rounded-md">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preview Column -->
                <div class="lg:h-screen lg:overflow-y-auto">
                    <div class="bg-secondary p-6 rounded-lg shadow-lg sticky top-8">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-headings">Live Preview</h2>
                            <div class="flex items-center gap-2">
                                <select id="platform-select" class="p-1 border rounded-md text-sm">
                                    <option value="0">No Limit</option>
                                    <option value="280">X (Twitter)</option>
                                    <option value="2200">Instagram</option>
                                    <option value="63206">Facebook</option>
                                </select>
                                <span id="charCount" class="text-sm font-medium text-secondary" aria-live="polite">0</span>
                            </div>
                        </div>
                        <div id="preview" class="preview-pane p-4 rounded-md h-96 overflow-y-auto"></div>
                        <div class="flex gap-2 mt-4">
                            <button id="copyButton" class="copy-button w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg text-lg shadow-md action-btn">
                                <span id="copyButtonText">Copy to Clipboard</span>
                            </button>
                            <div class="dropdown">
                                <button id="exportBtn" class="w-full h-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg text-lg shadow-md action-btn">Export</button>
                                <div id="exportDropdown" class="dropdown-content">
                                    <a href="#" id="exportTxt">as Plain Text (.txt)</a>
                                    <a href="#" id="exportMd">as Markdown (.md)</a>
                                    <a href="#" id="exportPdf">as PDF Document</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="loadPostsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="loadPostsModalTitle"><div class="modal-content"><button class="close-button" id="closeLoadModal" aria-label="Close modal">&times;</button><h2 id="loadPostsModalTitle" class="text-2xl font-bold mb-4 text-headings">Load a Saved Post</h2><input type="search" id="postSearchInput" placeholder="Search posts by name..." class="w-full p-2 border rounded-md mb-4"><div id="savedPostsList" class="space-y-2 max-h-80 overflow-y-auto"><p class="text-secondary">No saved posts found.</p></div><div class="mt-6 pt-4 border-t border-border-color flex gap-2"><button id="exportPostsBtn" class="action-btn w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Export All</button><button id="importPostsBtn" class="action-btn w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Import</button><input type="file" id="importFileInput" class="hidden" accept=".json"></div></div></div>
    <div id="templatesModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="templatesModalTitle"><div class="modal-content"><button class="close-button" id="closeTemplatesModal" aria-label="Close modal">&times;</button><h2 id="templatesModalTitle" class="text-2xl font-bold mb-4 text-headings">Manage Templates</h2><div id="templatesList" class="space-y-2 max-h-80 overflow-y-auto"><p class="text-secondary">No templates saved.</p></div><div class="mt-6 pt-4 border-t border-border-color flex gap-2"><button id="saveAsTemplateBtn" class="action-btn w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Save Current as Template</button></div></div></div>
    <div id="historyModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="historyModalTitle"><div class="modal-content"><button class="close-button" id="closeHistoryModal" aria-label="Close modal">&times;</button><h2 id="historyModalTitle" class="text-2xl font-bold mb-4 text-headings">Post History</h2><div id="historyList" class="space-y-2 max-h-80 overflow-y-auto"><p class="text-secondary">No history found.</p></div></div></div>
    <div id="confirmModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle"><div class="modal-content"><h2 id="confirmModalTitle" class="text-xl font-bold mb-4 text-headings">Confirm Action</h2><p id="confirmModalText" class="mb-6 text-primary">Are you sure?</p><div class="flex justify-end space-x-4"><button id="confirmCancelBtn" class="action-btn px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-md">Cancel</button><button id="confirmOkBtn" class="action-btn px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md">Confirm</button></div></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- App State ---
        let currentPostId = null;
        let currentPostName = 'New Post';
        const LOCAL_STORAGE_KEY = 'blacklistGeneratorPosts';
        const TEMPLATES_KEY = 'blacklistGeneratorTemplates';
        const VERSIONS_PREFIX = 'blacklistPostVersions_';
        const AUTOSAVE_KEY = 'blacklistGeneratorAutosave';
        const THEME_KEY = 'blacklistGeneratorTheme';
        let autosaveInterval;
        let _confirmCallbacks = { onConfirm: null, onCancel: null };

        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const formColumn = document.getElementById('form-column');
        const stickyHeader = document.getElementById('sticky-header');
        const preview = document.getElementById('preview');
        const charCount = document.getElementById('charCount');
        const platformSelect = document.getElementById('platform-select');
        const editingStatus = document.getElementById('editingStatus');
        const themeToggle = document.getElementById('theme-toggle');
        const copyButtonText = document.getElementById('copyButtonText');
        const exportBtn = document.getElementById('exportBtn');
        const exportDropdown = document.getElementById('exportDropdown');

        const fields = {
            subjectName: document.getElementById('subjectName'), caseType: document.getElementById('caseType'),
            location: document.getElementById('location'), updateDate: document.getElementById('updateDate'),
            caseUpdate: document.getElementById('caseUpdate'), trialDate: document.getElementById('trialDate'),
            backgroundInfo: document.getElementById('backgroundInfo'), emergingReports: document.getElementById('emergingReports'),
            hashtags: document.getElementById('hashtags'),
        };

        const containers = {
            individuals: document.getElementById('individualsContainer'), aliases: document.getElementById('aliasesContainer'),
            organizations: document.getElementById('organizationsContainer'), legalRegistrations: document.getElementById('legalRegistrationsContainer'),
            fraudulentSolicitations: document.getElementById('fraudulentSolicitationsContainer'), warningsAndAccounts: document.getElementById('warningsAndAccountsContainer'),
            investigations: document.getElementById('investigationsContainer'), evidence: document.getElementById('evidenceContainer'),
            articles: document.getElementById('articlesContainer'),
        };

        const buttons = {
            addIndividual: document.getElementById('addIndividual'), addAlias: document.getElementById('addAlias'),
            addOrganization: document.getElementById('addOrganization'), addLegalRegistration: document.getElementById('addLegalRegistration'),
            addFraudulentSolicitation: document.getElementById('addFraudulentSolicitation'), addWarningAndAccount: document.getElementById('addWarningAndAccount'),
            addInvestigation: document.getElementById('addInvestigation'), addEvidence: document.getElementById('addEvidence'),
            addArticle: document.getElementById('addArticle'), newPost: document.getElementById('newPost'),
            copy: document.getElementById('copyButton'), saveOrUpdate: document.getElementById('saveOrUpdate'),
            saveAsNew: document.getElementById('saveAsNew'), load: document.getElementById('loadPosts'),
            loadTemplate: document.getElementById('loadTemplate'),
            exportPostsBtn: document.getElementById('exportPostsBtn'), importPostsBtn: document.getElementById('importPostsBtn'),
            saveAsTemplateBtn: document.getElementById('saveAsTemplateBtn'),
            summarizeBackground: document.getElementById('summarizeBackground'),
            expandReports: document.getElementById('expandReports'),
            suggestHashtags: document.getElementById('suggestHashtags'),
            exportTxt: document.getElementById('exportTxt'),
            exportMd: document.getElementById('exportMd'),
            exportPdf: document.getElementById('exportPdf'),
        };
        
        const modals = {
            loadPosts: document.getElementById('loadPostsModal'),
            templates: document.getElementById('templatesModal'),
            history: document.getElementById('historyModal'),
            confirm: document.getElementById('confirmModal'),
        };

        const closeButtons = {
            loadPosts: document.getElementById('closeLoadModal'),
            templates: document.getElementById('closeTemplatesModal'),
            history: document.getElementById('closeHistoryModal'),
        };

        const lists = {
            savedPosts: document.getElementById('savedPostsList'),
            templates: document.getElementById('templatesList'),
            history: document.getElementById('historyList'),
        };
        
        const postSearchInput = document.getElementById('postSearchInput');
        const importFileInput = document.getElementById('importFileInput');

        // --- Debounce Function ---
        function debounce(func, delay) { let timeoutId; return function(...args) { clearTimeout(timeoutId); timeoutId = setTimeout(() => { func.apply(this, args); }, delay); }; }
        const debouncedUpdatePreview = debounce(updatePreview, 250);

        // --- Event Listeners ---
        formColumn.addEventListener('input', (e) => {
            if (e.target.closest('.form-section') || e.target.closest('.summary-section')) {
                debouncedUpdatePreview();
                startAutosave();
            }
        });
        formColumn.addEventListener('scroll', () => {
            stickyHeader.classList.toggle('scrolled', formColumn.scrollTop > 0);
        });
        Object.values(buttons).forEach(btn => btn?.addEventListener('click', handleButtonClick));
        document.querySelectorAll('.form-section-header').forEach(header => {
            header.addEventListener('click', toggleSection);
            header.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleSection(e); } });
        });
        document.addEventListener('click', handleDynamicItemControls);
        themeToggle.addEventListener('change', toggleTheme);
        postSearchInput.addEventListener('input', openLoadModal);
        platformSelect.addEventListener('change', updatePreview);
        
        exportBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            exportBtn.parentElement.classList.toggle('show');
        });
        document.addEventListener('click', (e) => {
            if (!exportBtn.contains(e.target)) {
                exportBtn.parentElement.classList.remove('show');
            }
        });

        // --- Modal Listeners ---
        Object.keys(closeButtons).forEach(key => {
            closeButtons[key].addEventListener('click', () => closeModal(modals[key]));
        });
        
        function handleConfirm(isConfirmed) {
            if (isConfirmed && typeof _confirmCallbacks.onConfirm === 'function') {
                _confirmCallbacks.onConfirm();
            } else if (!isConfirmed && typeof _confirmCallbacks.onCancel === 'function') {
                _confirmCallbacks.onCancel();
            }
            closeModal(modals.confirm);
        }

        document.getElementById('confirmOkBtn').addEventListener('click', () => handleConfirm(true));
        document.getElementById('confirmCancelBtn').addEventListener('click', () => handleConfirm(false));

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                Object.values(modals).forEach(modal => {
                    if (modal.style.display === 'flex') {
                        if (modal === modals.confirm) handleConfirm(false);
                        else closeModal(modal);
                    }
                });
            }
        });

        // --- Event Handlers ---
        function handleButtonClick(e) {
            switch (e.currentTarget.id) {
                case 'addIndividual': addDynamicItem('individual'); break;
                case 'addAlias': addDynamicItem('alias'); break;
                case 'addOrganization': addDynamicItem('organization'); break;
                case 'addLegalRegistration': addDynamicItem('legalRegistration'); break;
                case 'addFraudulentSolicitation': addDynamicItem('fraudulentSolicitation'); break;
                case 'addWarningAndAccount': addDynamicItem('warningAndAccount'); break;
                case 'addInvestigation': addDynamicItem('investigation'); break;
                case 'addEvidence': addDynamicItem('evidence'); break;
                case 'addArticle': addDynamicItem('article'); break;
                case 'newPost': confirmAndClearForm(); break;
                case 'copyButton': copyToClipboard(); break;
                case 'saveOrUpdate': saveOrUpdatePost(); break;
                case 'saveAsNew': saveNewPost(true); break;
                case 'loadPosts': openLoadModal(); break;
                case 'loadTemplate': openTemplatesModal(); break;
                case 'saveAsTemplateBtn': saveCurrentAsTemplate(); break;
                case 'exportPostsBtn': exportPosts(); break;
                case 'importPostsBtn': importFileInput.click(); break;
                case 'summarizeBackground': handleAIAssist('summarize', fields.backgroundInfo); break;
                case 'expandReports': handleAIAssist('expand', fields.emergingReports); break;
                case 'suggestHashtags': handleAIAssist('hashtags', fields.hashtags); break;
                case 'exportTxt': exportAsTxt(); break;
                case 'exportMd': exportAsMd(); break;
                case 'exportPdf': exportAsPdf(); break;
            }
        }
        
        importFileInput.addEventListener('change', handleImport);

        function handleDynamicItemControls(e) {
            const button = e.target.closest('.control-btn');
            if (!button) return;
            const item = button.closest('.dynamic-item');
            const container = item.parentElement;
            if (button.getAttribute('aria-label') === 'Remove item') {
                item.remove();
            } else if (button.getAttribute('aria-label') === 'Move item up') {
                const prevSibling = item.previousElementSibling;
                if (prevSibling) container.insertBefore(item, prevSibling);
            } else if (button.getAttribute('aria-label') === 'Move item down') {
                const nextSibling = item.nextElementSibling;
                if (nextSibling) container.insertBefore(nextSibling, item);
            }
            updateItemControls(container);
            debouncedUpdatePreview();
            startAutosave();
        }

        function toggleSection(e) {
            const header = e.currentTarget;
            const content = document.getElementById(header.getAttribute('aria-controls'));
            const icon = header.querySelector('.chevron-icon');
            const isExpanded = header.getAttribute('aria-expanded') === 'true';
            header.setAttribute('aria-expanded', !isExpanded);
            header.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
            icon.classList.toggle('collapsed');
        }

        // --- Dynamic Item Management ---
        const typeToContainerKey = {
            individual: 'individuals', alias: 'aliases', organization: 'organizations',
            legalRegistration: 'legalRegistrations', fraudulentSolicitation: 'fraudulentSolicitations',
            warningAndAccount: 'warningsAndAccounts', investigation: 'investigations',
            evidence: 'evidence', article: 'articles'
        };

        const itemTemplates = {
            individual: (id) => `<div class="flex gap-4"><img class="image-preview" id="img-preview-${id}" src="https://placehold.co/64x64/f8fafc/cbd5e1?text=üñºÔ∏è" onerror="this.onerror=null;this.src='https://placehold.co/64x64/f8fafc/cbd5e1?text=‚ùå';"><div class="flex-grow"><label for="individual-img-${id}" class="block text-sm font-medium text-secondary mb-1">Image URL</label><input type="url" id="individual-img-${id}" class="w-full p-2 border rounded-md mb-2 individual-image-url" oninput="document.getElementById('img-preview-${id}').src=this.value || 'https://placehold.co/64x64/f8fafc/cbd5e1?text=üñºÔ∏è'"></div></div><div><label for="individual-name-${id}" class="block text-sm font-medium text-secondary mb-1">Full Name</label><input type="text" id="individual-name-${id}" class="w-full p-2 border rounded-md mb-2 individual-name"></div><div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2"><div><label for="individual-dob-${id}" class="block text-sm font-medium text-secondary mb-1">Date of Birth</label><input type="text" id="individual-dob-${id}" class="w-full p-2 border rounded-md individual-dob"></div><div><label for="individual-phone-${id}" class="block text-sm font-medium text-secondary mb-1">Phone Number</label><input type="tel" id="individual-phone-${id}" class="w-full p-2 border rounded-md individual-phone"></div></div><div><label for="individual-email-${id}" class="block text-sm font-medium text-secondary mb-1">Email Address</label><input type="email" id="individual-email-${id}" class="w-full p-2 border rounded-md mb-2 individual-email"></div><div><label for="individual-address-${id}" class="block text-sm font-medium text-secondary mb-1">Last Known Address</label><textarea id="individual-address-${id}" rows="2" class="w-full p-2 border rounded-md mb-2 individual-address"></textarea></div><h4 class="font-semibold text-sm mt-3 mb-1 text-gray-600 dark:text-gray-400">Social Media Links</h4><div class="space-y-2"><input type="url" placeholder="Facebook URL" class="w-full p-2 border rounded-md individual-fb-link" aria-label="Individual Facebook URL"><input type="url" placeholder="Instagram URL" class="w-full p-2 border rounded-md individual-ig-link" aria-label="Individual Instagram URL"><input type="url" placeholder="X (Twitter) URL" class="w-full p-2 border rounded-md individual-x-link" aria-label="Individual X (Twitter) URL"><input type="text" placeholder="Other URLs (comma-sep)" class="w-full p-2 border rounded-md individual-other-links" aria-label="Individual Other URLs"></div>`,
            alias: (id) => `<div><label for="alias-name-${id}" class="block text-sm font-medium text-secondary mb-1">Alias Name</label><input type="text" id="alias-name-${id}" class="w-full p-2 border rounded-md alias-name"></div>`,
            organization: (id) => `<div><label for="org-name-${id}" class="block text-sm font-medium text-secondary mb-1">Organization Name</label><input type="text" id="org-name-${id}" class="w-full p-2 border rounded-md mb-2 org-name"></div><div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2"><div><label for="org-ein-${id}" class="block text-sm font-medium text-secondary mb-1">EIN</label><input type="text" id="org-ein-${id}" class="w-full p-2 border rounded-md org-ein"></div><div><label for="org-license-${id}" class="block text-sm font-medium text-secondary mb-1">License #</label><input type="text" id="org-license-${id}" class="w-full p-2 border rounded-md org-license"></div></div><div><label for="org-record-${id}" class="block text-sm font-medium text-secondary mb-1">Official Record Link</label><input type="url" id="org-record-${id}" class="w-full p-2 border rounded-md mb-2 org-record-link"></div><div><label for="org-status-${id}" class="block text-sm font-medium text-secondary mb-1">Status</label><input type="text" id="org-status-${id}" placeholder="e.g., Active, CLOSED" class="w-full p-2 border rounded-md mb-2 org-status"></div><h4 class="font-semibold text-sm mt-3 mb-1 text-gray-600 dark:text-gray-400">Links</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-2"><input type="url" placeholder="Facebook URL" class="w-full p-2 border rounded-md org-fb-link" aria-label="Organization Facebook URL"><input type="url" placeholder="Instagram URL" class="w-full p-2 border rounded-md org-ig-link" aria-label="Organization Instagram URL"><input type="url" placeholder="X (Twitter) URL" class="w-full p-2 border rounded-md org-x-link" aria-label="Organization X (Twitter) URL"><input type="url" placeholder="Website URL" class="w-full p-2 border rounded-md org-website-link" aria-label="Organization Website URL"></div><div class="mt-2"><input type="text" placeholder="Other URLs (comma-sep)" class="w-full p-2 border rounded-md org-other-links" aria-label="Organization Other URLs"></div>`,
            legalRegistration: (id) => `<div><label for="legal-title-${id}" class="block text-sm font-medium text-secondary mb-1">Document Title</label><input type="text" id="legal-title-${id}" class="w-full p-2 border rounded-md mb-2 legal-registration-title"></div><div><label for="legal-url-${id}" class="block text-sm font-medium text-secondary mb-1">URL</label><input type="url" id="legal-url-${id}" class="w-full p-2 border rounded-md mb-2 legal-registration-url"></div>`,
            fraudulentSolicitation: (id) => `<div><label for="fraud-text-${id}" class="block text-sm font-medium text-secondary mb-1">Allegation Details</label><textarea id="fraud-text-${id}" rows="3" class="w-full p-2 border rounded-md fraudulent-solicitation-text"></textarea></div>`,
            warningAndAccount: (id) => `<div><label for="warning-text-${id}" class="block text-sm font-medium text-secondary mb-1">Account/Warning Details</label><textarea id="warning-text-${id}" rows="3" class="w-full p-2 border rounded-md warning-account-text"></textarea></div>`,
            investigation: (id) => `<div><label for="inv-title-${id}" class="block text-sm font-medium text-secondary mb-1">Title</label><input type="text" id="inv-title-${id}" class="w-full p-2 border rounded-md mb-2 investigation-title"></div><div><label for="inv-url-${id}" class="block text-sm font-medium text-secondary mb-1">URL</label><input type="url" id="inv-url-${id}" class="w-full p-2 border rounded-md mb-2 investigation-url"></div>`,
            evidence: (id) => `<div class="flex gap-4"><img class="image-preview" id="img-preview-${id}" src="https://placehold.co/64x64/f8fafc/cbd5e1?text=üñºÔ∏è" onerror="this.onerror=null;this.src='https://placehold.co/64x64/f8fafc/cbd5e1?text=‚ùå';"><div class="flex-grow"><label for="evidence-img-${id}" class="block text-sm font-medium text-secondary mb-1">Image URL</label><input type="url" id="evidence-img-${id}" class="w-full p-2 border rounded-md mb-2 evidence-image-url" oninput="document.getElementById('img-preview-${id}').src=this.value || 'https://placehold.co/64x64/f8fafc/cbd5e1?text=üñºÔ∏è'"></div></div><div><label for="evidence-title-${id}" class="block text-sm font-medium text-secondary mb-1">Title</label><input type="text" id="evidence-title-${id}" class="w-full p-2 border rounded-md mb-2 evidence-title"></div><div><label for="evidence-desc-${id}" class="block text-sm font-medium text-secondary mb-1">Description</label><textarea id="evidence-desc-${id}" rows="3" class="w-full p-2 border rounded-md mb-2 evidence-description"></textarea></div><div class="grid grid-cols-1 md:grid-cols-2 gap-2"><div><label for="evidence-url-${id}" class="block text-sm font-medium text-secondary mb-1">URL</label><input type="url" id="evidence-url-${id}" class="w-full p-2 border rounded-md evidence-url"></div><div><label for="evidence-date-${id}" class="block text-sm font-medium text-secondary mb-1">Date (Optional)</label><input type="date" id="evidence-date-${id}" class="w-full p-2 border rounded-md evidence-date"></div></div>`,
            article: (id) => `<div><label for="art-title-${id}" class="block text-sm font-medium text-secondary mb-1">Title</label><input type="text" id="art-title-${id}" class="w-full p-2 border rounded-md mb-2 article-title"></div><div><label for="art-url-${id}" class="block text-sm font-medium text-secondary mb-1">URL</label><input type="url" id="art-url-${id}" class="w-full p-2 border rounded-md mb-2 article-url"></div>`
        };

        function addDynamicItem(type, options = {}) {
            const { suppressSideEffects = false } = options;
            const containerKey = typeToContainerKey[type];
            if (!containerKey) { console.error(`No container key found for type: ${type}`); return null; }
            const container = containers[containerKey];
            if (!container) { console.error(`Container not found for key: ${containerKey}`); return null; }
            
            const uniqueId = `${type}-${Date.now()}`;
            const div = document.createElement('div');
            div.className = 'dynamic-item';
            div.innerHTML = `<div class="item-controls"><button class="control-btn up-btn" aria-label="Move item up">‚ñ≤</button><button class="control-btn down-btn" aria-label="Move item down">‚ñº</button><button class="control-btn remove-btn" aria-label="Remove item">X</button></div>${itemTemplates[type](uniqueId)}`;
            
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) emptyState.style.display = 'none';
            
            container.appendChild(div);

            if (!suppressSideEffects) {
                updateItemControls(container);
                debouncedUpdatePreview();
                startAutosave();
            }
            return div;
        }

        // --- Core Logic: Preview & Formatting ---
        function updatePreview() {
            const textForCount = generatePostText(false);
            const htmlForPreview = generatePostText(true);

            preview.innerHTML = renderMarkdown(htmlForPreview);
            
            const limit = parseInt(platformSelect.value, 10);
            charCount.classList.toggle('char-count-limit-exceeded', limit > 0 && textForCount.length > limit);
            charCount.textContent = limit > 0 ? `${textForCount.length} / ${limit}` : `${textForCount.length}`;
        }

        function generatePostText(forPreview = false) {
            let post = '';
            const placeholderUrl = 'https://placehold.co/64x64/f8fafc/cbd5e1?text=‚ùå';
            if (fields.subjectName.value || fields.caseType.value) { post += `**ùêîùêèùêÉùêÄùêìùêÑ: ${fields.subjectName.value} ${fields.caseType.value} ‚Äì ${fields.location.value}**\n\n`; }
            if (fields.updateDate.value) { post += `As of **${new Date(fields.updateDate.value + 'T00:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }).toUpperCase()}**, ...\n`; }
            if (fields.caseUpdate.value) { post += `${fields.caseUpdate.value}\n\n`; }
            if (fields.trialDate.value) { post += `**Her ùêâùêÆùê´ùê≤ ùê≠ùê´ùê¢ùêöùê• ùê¢ùê¨ ùê¨ùêûùê≠ ùêüùê®ùê´ ${fields.trialDate.value}.**\n\n`; }

            const individuals = containers.individuals.querySelectorAll('.dynamic-item');
            const aliases = Array.from(containers.aliases.querySelectorAll('.alias-name')).map(input => input.value.trim()).filter(Boolean);
            const organizations = containers.organizations.querySelectorAll('.dynamic-item');
            if (individuals.length > 0 || organizations.length > 0) { post += '‚ñÄ‚ñÑ‚ñÄ‚ñÑ **ùë©ùë≥ùë®ùë™ùë≤ùë≥ùë∞ùë∫ùëªùë¨ùë´** ‚ñÑ‚ñÄ‚ñÑ‚ñÄ\n\n'; }
            
            individuals.forEach(ind => {
                const name = ind.querySelector('.individual-name').value, dob = ind.querySelector('.individual-dob').value, phone = ind.querySelector('.individual-phone').value, email = ind.querySelector('.individual-email').value, address = ind.querySelector('.individual-address').value, imageUrl = ind.querySelector('.individual-image-url').value;
                if (forPreview && imageUrl) {
                    post += `<div class="my-2"><img src="${imageUrl}" class="inline-block h-16 w-16 rounded-md object-cover" onerror="this.onerror=null;this.src='${placeholderUrl}';"><br><a href="${imageUrl}" class="text-xs text-blue-500" target="_blank" rel="noopener noreferrer">${imageUrl}</a></div>`;
                } else if (!forPreview && imageUrl) {
                    post += `[IMAGE: ${name || 'Individual'}]\n`;
                }
                const fbLink = ind.querySelector('.individual-fb-link').value, igLink = ind.querySelector('.individual-ig-link').value, xLink = ind.querySelector('.individual-x-link').value, otherLinks = ind.querySelector('.individual-other-links').value.split(',').map(l => l.trim()).filter(l => l);
                if (name) post += `**${name}**\n`; if (dob) post += `DOB: ${dob}\n`; if (address) post += `Address: ${address}\n`; if (phone) post += `Phone: ${phone}\n`; if (email) post += `Email: ${email}\n`;
                if (fbLink) post += `[Facebook](${fbLink})\n`; if (igLink) post += `[Instagram](${igLink})\n`; if (xLink) post += `[X (Twitter)](${xLink})\n`;
                otherLinks.forEach(link => { let linkName = 'Link'; try { linkName = new URL(link).hostname.replace('www.', ''); } catch (e) {} post += `[${linkName}](${link})\n`; });
                post += '\n---\n\n';
            });
            
            if (aliases.length > 0) { post += `**She goes by the names of ${aliases.join(', ')} and uses other fake accounts and names.**\n\n---\n\n`; }
            
            organizations.forEach(org => {
                const name = org.querySelector('.org-name').value; if (!name) return;
                post += `**${name}**\n`;
                const ein = org.querySelector('.org-ein').value, license = org.querySelector('.org-license').value, recordLink = org.querySelector('.org-record-link').value, status = org.querySelector('.org-status').value;
                const fbLink = org.querySelector('.org-fb-link').value, igLink = org.querySelector('.org-ig-link').value, xLink = org.querySelector('.org-x-link').value, websiteLink = org.querySelector('.org-website-link').value;
                const otherLinks = org.querySelector('.org-other-links').value.split(',').map(l => l.trim()).filter(l => l);
                if (ein) post += `EIN: ${ein}\n`; if (license) post += `License: ${license}\n`; if (recordLink) post += `[Official Record](${recordLink})\n`; if (status) post += `Status: **${status}**\n`;
                if (fbLink) post += `[FB](${fbLink})\n`; if (igLink) post += `[IG](${igLink})\n`; if (xLink) post += `[X (Twitter)](${xLink})\n`; if (websiteLink) post += `[Website](${websiteLink})\n`;
                otherLinks.forEach(link => { let linkName = 'Link'; try { linkName = new URL(link).hostname.replace('www.', ''); } catch (e) {} post += `[${linkName}](${link})\n`; });
                post += '\n---\n\n';
            });

            const legalRegs = containers.legalRegistrations.querySelectorAll('.dynamic-item');
            if (legalRegs.length > 0) { post += '**Legal Registration**\n'; legalRegs.forEach(item => { const title = item.querySelector('.legal-registration-title').value, url = item.querySelector('.legal-registration-url').value; if (title && url) post += `* [${title}](${url})\n`; }); post += '\n---\n\n'; }
            
            const fraudAllegations = Array.from(containers.fraudulentSolicitations.querySelectorAll('.fraudulent-solicitation-text')).map(input => input.value.trim()).filter(Boolean);
            if (fraudAllegations.length > 0) { post += '**Allegations of Fraudulent Solicitations**\n'; fraudAllegations.forEach(text => { post += `* ${text}\n`; }); post += '\n---\n\n'; }

            const warnings = Array.from(containers.warningsAndAccounts.querySelectorAll('.warning-account-text')).map(input => input.value.trim()).filter(Boolean);
            if (warnings.length > 0) { post += '**Warnings and First-Hand Accounts**\n'; warnings.forEach(text => { post += `* ${text}\n`; }); post += '\n---\n\n'; }

            const investigations = containers.investigations.querySelectorAll('.dynamic-item');
            if (investigations.length > 0) { post += '**Animal Cruelty Investigations**\n'; investigations.forEach(inv => { const title = inv.querySelector('.investigation-title').value, url = inv.querySelector('.investigation-url').value; if (title && url) post += `* [${title}](${url})\n`; }); post += '\n---\n\n'; }
            
            const evidenceItems = containers.evidence.querySelectorAll('.dynamic-item');
            if (evidenceItems.length > 0) { post += '**Enhanced Documentation & Evidence**\n'; evidenceItems.forEach(item => { const title = item.querySelector('.evidence-title').value, desc = item.querySelector('.evidence-description').value, url = item.querySelector('.evidence-url').value, date = item.querySelector('.evidence-date').value, imageUrl = item.querySelector('.evidence-image-url').value; 
                if (forPreview && imageUrl) {
                    post += `<div class="my-2"><img src="${imageUrl}" class="inline-block h-16 w-16 rounded-md object-cover" onerror="this.onerror=null;this.src='${placeholderUrl}';"><br><a href="${imageUrl}" class="text-xs text-blue-500" target="_blank" rel="noopener noreferrer">${imageUrl}</a></div>`;
                } else if (!forPreview && imageUrl) {
                    post += `[IMAGE: ${title || 'Evidence'}]\n`;
                }
                if(title) { post += `* **${title}**`; if(date){ post += ` (${new Date(date + 'T00:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })})`}; post += `\n`; } if(desc){ post += `  ${desc.replace(/\n/g, '\n  ')}\n`; } if(url){ post += `  [Source Link](${url})\n`; } post += '\n'; }); post += '---\n\n'; }

            const articles = containers.articles.querySelectorAll('.dynamic-item');
            if (articles.length > 0) { post += '**News Articles and Legal Documents**\n'; articles.forEach(art => { const title = art.querySelector('.article-title').value, url = art.querySelector('.article-url').value; if (title && url) post += `* [${title}](${url})\n`; }); post += '\n'; }

            if (fields.backgroundInfo.value) { post += `${fields.backgroundInfo.value}\n\n`; }
            if (fields.emergingReports.value) { post += `**MORE REPORTS EMERGING. ALLEGEDLY, ${fields.emergingReports.value.toUpperCase()}**\n\n`; }
            
            post += '### Disclaimer:\n***The information shared in this post is based on publicly available information...***\n\n';
            if (fields.hashtags.value) { post += `${fields.hashtags.value}\n`; }
            
            return post;
        }

        function renderMarkdown(text) { return text.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>').replace(/^### (.*$)/gim, '<h3>$1</h3>').replace(/^## (.*$)/gim, '<h2>$1</h2>').replace(/^# (.*$)/gim, '<h1>$1</h1>').replace(/^\* (.*$)/gim, '<li>$1</li>').replace(/\n/g, '<br>'); }
        
        // --- Local Storage & Data Functions ---
        function getFromStorage(key) { try { return JSON.parse(localStorage.getItem(key)) || []; } catch (e) { return []; } }
        function saveToStorage(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
        
        function saveOrUpdatePost() { if (currentPostId) { updatePost(); } else { saveNewPost(); } }
        
        function saveNewPost(isSaveAs = false) {
            const defaultName = fields.subjectName.value || "Untitled Post";
            const promptName = isSaveAs && currentPostName !== 'New Post' ? `${currentPostName} (Copy)` : defaultName;
            const postName = prompt("Enter a name for this new post:", promptName);
            if (!postName) return;
            
            const data = getFormData();
            data.name = postName;
            data.savedAt = new Date().toISOString();
            data.id = crypto.randomUUID();
            
            currentPostId = data.id;
            currentPostName = data.name;

            const posts = getFromStorage(LOCAL_STORAGE_KEY);
            posts.push(data);
            saveToStorage(LOCAL_STORAGE_KEY, posts);
            showToast(`Post "${postName}" saved.`, 'success');
            clearAutosave();
            updateUIForState();
        }

        function updatePost() {
            if (!currentPostId) return;
            
            const posts = getFromStorage(LOCAL_STORAGE_KEY);
            const postIndex = posts.findIndex(p => p.id === currentPostId);
            if (postIndex > -1) {
                saveVersion(currentPostId, posts[postIndex]);
                const data = getFormData();
                data.savedAt = new Date().toISOString();
                data.id = currentPostId;
                data.name = currentPostName;
                posts[postIndex] = data;
                saveToStorage(LOCAL_STORAGE_KEY, posts);
                showToast(`Post "${data.name}" updated.`, 'success');
                clearAutosave();
                updateUIForState();
            } else {
                saveNewPost();
            }
        }
        
        function openLoadModal(e) {
            const searchTerm = postSearchInput.value.toLowerCase();
            const posts = getFromStorage(LOCAL_STORAGE_KEY);
            lists.savedPosts.innerHTML = '';

            const filteredPosts = posts.filter(post => post.name.toLowerCase().includes(searchTerm));

            if (filteredPosts.length === 0) {
                lists.savedPosts.innerHTML = `<p class="text-secondary">No ${searchTerm ? 'matching' : 'saved'} posts found.</p>`;
                if (!e || e.type !== 'input') openModal(modals.loadPosts);
                return;
            }

            filteredPosts.sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));
            filteredPosts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'modal-list-item';
                postElement.innerHTML = `
                    <div class="modal-list-item-text" data-post-id="${post.id}">
                        <span class="text-primary">${post.name}</span> 
                        <span class="text-xs text-secondary ml-2">${new Date(post.savedAt).toLocaleDateString()}</span>
                    </div>
                    <div class="modal-list-item-controls">
                        <button class="modal-control-btn" data-history-id="${post.id}" title="View History">üïí</button>
                        <button class="modal-control-btn" data-export-id="${post.id}" title="Export Post">üì§</button>
                        <button class="modal-control-btn" data-delete-id="${post.id}" data-delete-name="${post.name}" title="Delete Post">üóëÔ∏è</button>
                    </div>`;
                lists.savedPosts.appendChild(postElement);
            });

            lists.savedPosts.addEventListener('click', (evt) => {
                const target = evt.target;
                if (target.closest('.modal-list-item-text')) {
                    loadSpecificPost(target.closest('.modal-list-item-text').dataset.postId);
                } else if (target.dataset.historyId) {
                    openHistoryModal(target.dataset.historyId);
                } else if (target.dataset.exportId) {
                    exportSinglePost(target.dataset.exportId);
                } else if (target.dataset.deleteId) {
                    deletePost(target.dataset.deleteId, target.dataset.deleteName);
                }
            }, { once: true });

            if (!e || e.type !== 'input') openModal(modals.loadPosts);
        }
        
        function loadSpecificPost(postId) {
            showConfirmation("Loading this post will overwrite your current unsaved changes. Continue?", () => {
                const postToLoad = getFromStorage(LOCAL_STORAGE_KEY).find(p => p.id === postId);
                if (postToLoad) {
                    populateForm(postToLoad);
                    closeModal(modals.loadPosts);
                    showToast(`Loaded post: ${postToLoad.name}`, 'success');
                }
            });
        }

        function deletePost(postId, postName) {
            showConfirmation(`Are you sure you want to delete "${postName}" and all its history? This cannot be undone.`, () => {
                saveToStorage(LOCAL_STORAGE_KEY, getFromStorage(LOCAL_STORAGE_KEY).filter(p => p.id !== postId));
                localStorage.removeItem(VERSIONS_PREFIX + postId);
                if (currentPostId === postId) {
                    clearForm();
                }
                openLoadModal();
                showToast(`Post "${postName}" deleted.`, 'success');
            });
        }

        // --- Utility Functions ---
        function copyToClipboard() {
            const textToCopy = generatePostText(false);
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                copyButtonText.textContent = '‚úî Copied!';
                setTimeout(() => { copyButtonText.textContent = 'Copy to Clipboard'; }, 2000);
            } catch (err) { showToast('Copy failed.', 'error'); }
            document.body.removeChild(textArea);
        }
        
        function clearForm() {
            Object.values(fields).forEach(el => el.value = '');
            Object.values(containers).forEach(c => {
                c.innerHTML = '';
                addEmptyStateMessage(c);
            });
            currentPostId = null;
            currentPostName = 'New Post';
            clearAutosave();
            updateUIForState();
            updatePreview();
        }
        
        function confirmAndClearForm() {
            const hasUnsavedChanges = localStorage.getItem(AUTOSAVE_KEY);
            if (hasUnsavedChanges) {
                showConfirmation("Are you sure you want to start a new post? All unsaved changes will be lost.", () => clearForm());
            } else {
                clearForm();
            }
        }

        function getFormData(isTemplate = false) {
            const data = { name: currentPostName, id: currentPostId };
            for (const key in fields) { data[key] = isTemplate ? '' : fields[key].value; }
            
            function processContainer(container, itemSelectors) {
                return Array.from(container.querySelectorAll('.dynamic-item')).map(() => {
                    if (isTemplate) {
                        const templateItem = {};
                        Object.keys(itemSelectors).forEach(key => templateItem[key] = '');
                        return templateItem;
                    }
                    return {}; 
                });
            }

            if (isTemplate) {
                data.individuals = processContainer(containers.individuals, {name:'', dob:'', phone:'', email:'', address:'', imageUrl:'', fbLink:'', igLink:'', xLink:'', otherLinks:''});
                data.aliases = processContainer(containers.aliases, {name:''});
                data.organizations = processContainer(containers.organizations, {name:'', ein:'', license:'', recordLink:'', status:'', fbLink:'', igLink:'', xLink:'', websiteLink:'', otherLinks:''});
                data.legalRegistrations = processContainer(containers.legalRegistrations, {title:'', url:''});
                data.fraudulentSolicitations = processContainer(containers.fraudulentSolicitations, {text:''});
                data.warningsAndAccounts = processContainer(containers.warningsAndAccounts, {text:''});
                data.investigations = processContainer(containers.investigations, {title:'', url:''});
                data.evidence = processContainer(containers.evidence, {title:'', description:'', url:'', date:'', imageUrl:''});
                data.articles = processContainer(containers.articles, {title:'', url:''});
            } else {
                data.individuals = Array.from(containers.individuals.querySelectorAll('.dynamic-item')).map(item => ({ name: item.querySelector('.individual-name').value, dob: item.querySelector('.individual-dob').value, phone: item.querySelector('.individual-phone').value, email: item.querySelector('.individual-email').value, address: item.querySelector('.individual-address').value, imageUrl: item.querySelector('.individual-image-url').value, fbLink: item.querySelector('.individual-fb-link').value, igLink: item.querySelector('.individual-ig-link').value, xLink: item.querySelector('.individual-x-link').value, otherLinks: item.querySelector('.individual-other-links').value, }));
                data.aliases = Array.from(containers.aliases.querySelectorAll('.dynamic-item')).map(item => ({ name: item.querySelector('.alias-name').value }));
                data.organizations = Array.from(containers.organizations.querySelectorAll('.dynamic-item')).map(item => ({ name: item.querySelector('.org-name').value, ein: item.querySelector('.org-ein').value, license: item.querySelector('.org-license').value, recordLink: item.querySelector('.org-record-link').value, status: item.querySelector('.org-status').value, fbLink: item.querySelector('.org-fb-link').value, igLink: item.querySelector('.org-ig-link').value, xLink: item.querySelector('.org-x-link').value, websiteLink: item.querySelector('.org-website-link').value, otherLinks: item.querySelector('.org-other-links').value, }));
                data.legalRegistrations = Array.from(containers.legalRegistrations.querySelectorAll('.dynamic-item')).map(item => ({ title: item.querySelector('.legal-registration-title').value, url: item.querySelector('.legal-registration-url').value }));
                data.fraudulentSolicitations = Array.from(containers.fraudulentSolicitations.querySelectorAll('.dynamic-item')).map(item => ({ text: item.querySelector('.fraudulent-solicitation-text').value }));
                data.warningsAndAccounts = Array.from(containers.warningsAndAccounts.querySelectorAll('.dynamic-item')).map(item => ({ text: item.querySelector('.warning-account-text').value }));
                data.investigations = Array.from(containers.investigations.querySelectorAll('.dynamic-item')).map(item => ({ title: item.querySelector('.investigation-title').value, url: item.querySelector('.investigation-url').value }));
                data.evidence = Array.from(containers.evidence.querySelectorAll('.dynamic-item')).map(item => ({ title: item.querySelector('.evidence-title').value, description: item.querySelector('.evidence-description').value, url: item.querySelector('.evidence-url').value, date: item.querySelector('.evidence-date').value, imageUrl: item.querySelector('.evidence-image-url').value }));
                data.articles = Array.from(containers.articles.querySelectorAll('.dynamic-item')).map(item => ({ title: item.querySelector('.article-title').value, url: item.querySelector('.article-url').value }));
            }
            return data;
        }

        function populateForm(data) {
            Object.values(fields).forEach(el => el.value = '');
            Object.values(containers).forEach(c => c.innerHTML = '');
            for (const key in fields) { if (data[key]) fields[key].value = data[key]; }
            data.individuals?.forEach(d => { const item = addDynamicItem('individual', { suppressSideEffects: true }); if(item){ item.querySelector('.individual-name').value = d.name || ''; item.querySelector('.individual-dob').value = d.dob || ''; item.querySelector('.individual-phone').value = d.phone || ''; item.querySelector('.individual-email').value = d.email || ''; item.querySelector('.individual-address').value = d.address || ''; item.querySelector('.individual-image-url').value = d.imageUrl || ''; item.querySelector('.individual-image-url').dispatchEvent(new Event('input')); item.querySelector('.individual-fb-link').value = d.fbLink || ''; item.querySelector('.individual-ig-link').value = d.igLink || ''; item.querySelector('.individual-x-link').value = d.xLink || ''; item.querySelector('.individual-other-links').value = d.otherLinks || ''; }});
            data.aliases?.forEach(d => { const item = addDynamicItem('alias', { suppressSideEffects: true }); if(item){ item.querySelector('.alias-name').value = d.name; }});
            data.organizations?.forEach(d => { const item = addDynamicItem('organization', { suppressSideEffects: true }); if(item){ item.querySelector('.org-name').value = d.name || ''; item.querySelector('.org-ein').value = d.ein || ''; item.querySelector('.org-license').value = d.license || ''; item.querySelector('.org-record-link').value = d.recordLink || ''; item.querySelector('.org-status').value = d.status || ''; item.querySelector('.org-fb-link').value = d.fbLink || ''; item.querySelector('.org-ig-link').value = d.igLink || ''; item.querySelector('.org-x-link').value = d.xLink || ''; item.querySelector('.org-website-link').value = d.websiteLink || ''; item.querySelector('.org-other-links').value = d.otherLinks || ''; }});
            data.legalRegistrations?.forEach(d => { const item = addDynamicItem('legalRegistration', { suppressSideEffects: true }); if(item){ item.querySelector('.legal-registration-title').value = d.title; item.querySelector('.legal-registration-url').value = d.url; }});
            data.fraudulentSolicitations?.forEach(d => { const item = addDynamicItem('fraudulentSolicitation', { suppressSideEffects: true }); if(item){ item.querySelector('.fraudulent-solicitation-text').value = d.text; }});
            data.warningsAndAccounts?.forEach(d => { const item = addDynamicItem('warningAndAccount', { suppressSideEffects: true }); if(item){ item.querySelector('.warning-account-text').value = d.text; }});
            data.investigations?.forEach(d => { const item = addDynamicItem('investigation', { suppressSideEffects: true }); if(item){ item.querySelector('.investigation-title').value = d.title; item.querySelector('.investigation-url').value = d.url; }});
            data.evidence?.forEach(d => { const item = addDynamicItem('evidence', { suppressSideEffects: true }); if(item){ item.querySelector('.evidence-title').value = d.title || ''; item.querySelector('.evidence-description').value = d.description || ''; item.querySelector('.evidence-url').value = d.url || ''; item.querySelector('.evidence-date').value = d.date || ''; item.querySelector('.evidence-image-url').value = d.imageUrl || ''; item.querySelector('.evidence-image-url').dispatchEvent(new Event('input')); }});
            data.articles?.forEach(d => { const item = addDynamicItem('article', { suppressSideEffects: true }); if(item){ item.querySelector('.article-title').value = d.title; item.querySelector('.article-url').value = d.url; }});
            currentPostId = data.id;
            currentPostName = data.name;
            Object.values(containers).forEach(updateItemControls);
            clearAutosave();
            updatePreview();
            updateUIForState();
        }

        // --- UI/UX & New Feature Functions ---
        function toggleTheme() {
            const isDark = themeToggle.checked;
            document.documentElement.classList.toggle('dark', isDark);
            localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light');
        }

        function updateItemControls(container) {
            if (!container) return;
            const items = container.querySelectorAll('.dynamic-item');
            const emptyState = container.querySelector('.empty-state');
            if (items.length === 0) { if (emptyState) emptyState.style.display = 'block'; return; }
            if (emptyState) emptyState.style.display = 'none';
            items.forEach((item, index) => {
                const upBtn = item.querySelector('.up-btn');
                const downBtn = item.querySelector('.down-btn');
                if (upBtn) upBtn.disabled = (index === 0);
                if (downBtn) downBtn.disabled = (index === items.length - 1);
            });
        }

        function addEmptyStateMessage(container) {
            if (!container.querySelector('.empty-state')) {
                const p = document.createElement('p');
                p.className = 'empty-state';
                p.textContent = 'No items added yet.';
                container.appendChild(p);
            }
        }

        function startAutosave() {
            clearInterval(autosaveInterval);
            editingStatus.textContent = 'Unsaved changes...';
            autosaveInterval = setInterval(() => {
                const data = getFormData();
                saveToStorage(AUTOSAVE_KEY, data);
                editingStatus.textContent = `Draft saved at ${new Date().toLocaleTimeString()}`;
            }, 10000);
        }

        function clearAutosave() {
            clearInterval(autosaveInterval);
            localStorage.removeItem(AUTOSAVE_KEY);
        }

        function loadAutosavedDraft() {
            const draft = localStorage.getItem(AUTOSAVE_KEY);
            if (draft) {
                showConfirmation( "We found an unsaved draft. Would you like to restore it?", () => {
                    try {
                        populateForm(JSON.parse(draft));
                        showToast("Draft restored.", 'info');
                    } catch (e) {
                        console.error("Failed to parse autosaved draft:", e);
                        showToast("Could not restore draft, it was corrupted.", 'error');
                        clearAutosave();
                        clearForm();
                    }
                }, () => clearForm());
            } else {
                clearForm();
            }
        }

        function exportPosts() {
            const posts = getFromStorage(LOCAL_STORAGE_KEY);
            if (posts.length === 0) { showToast("No posts to export.", 'error'); return; }
            const dataStr = JSON.stringify(posts, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.download = `blacklist_posts_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
            showToast("Posts exported successfully.", 'success');
        }

        function exportSinglePost(postId) {
            const post = getFromStorage(LOCAL_STORAGE_KEY).find(p => p.id === postId);
            if (!post) { showToast("Post not found for export.", "error"); return; }
            const dataStr = JSON.stringify(post, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.download = `${post.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedPosts = JSON.parse(e.target.result);
                    if (!Array.isArray(importedPosts)) throw new Error("Invalid format");
                    
                    showConfirmation(`Found ${importedPosts.length} posts. Do you want to merge these by adding new posts from the file?`, () => {
                        const existingPosts = getFromStorage(LOCAL_STORAGE_KEY);
                        const existingIds = new Set(existingPosts.map(p => p.id));
                        let addedCount = 0;
                        importedPosts.forEach(p => {
                            if (p && p.id && !existingIds.has(p.id)) {
                                existingPosts.push(p);
                                addedCount++;
                            }
                        });
                        saveToStorage(LOCAL_STORAGE_KEY, existingPosts);
                        showToast(`${addedCount} new posts imported successfully!`, 'success');
                        openLoadModal();
                    });
                } catch (err) {
                    showToast("Import failed. Invalid file format.", 'error');
                } finally {
                    importFileInput.value = '';
                }
            };
            reader.readAsText(file);
        }
        
        // --- Template Functions ---
        function openTemplatesModal() {
            const templates = getFromStorage(TEMPLATES_KEY);
            lists.templates.innerHTML = '';
            if (templates.length === 0) {
                lists.templates.innerHTML = '<p class="text-secondary">No templates saved.</p>';
            } else {
                templates.forEach(template => {
                    const el = document.createElement('div');
                    el.className = 'modal-list-item';
                    el.innerHTML = `<div class="modal-list-item-text" data-template-id="${template.id}">${template.name}</div><div class="modal-list-item-controls"><button class="modal-control-btn" data-delete-id="${template.id}" data-delete-name="${template.name}" title="Delete Template">üóëÔ∏è</button></div>`;
                    lists.templates.appendChild(el);
                });
            }
            lists.templates.addEventListener('click', (evt) => {
                const target = evt.target;
                if (target.closest('.modal-list-item-text')) {
                    loadTemplate(target.closest('.modal-list-item-text').dataset.templateId);
                } else if (target.dataset.deleteId) {
                    deleteTemplate(target.dataset.deleteId, target.dataset.deleteName);
                }
            }, { once: true });
            openModal(modals.templates);
        }

        function saveCurrentAsTemplate() {
            const templateName = prompt("Enter a name for this template:");
            if (!templateName) return;
            const data = getFormData(true);
            data.name = templateName;
            data.id = crypto.randomUUID();
            const templates = getFromStorage(TEMPLATES_KEY);
            templates.push(data);
            saveToStorage(TEMPLATES_KEY, templates);
            showToast(`Template "${templateName}" saved.`, 'success');
            openTemplatesModal();
        }

        function loadTemplate(templateId) {
            showConfirmation("Loading this template will overwrite your current unsaved changes. Continue?", () => {
                const template = getFromStorage(TEMPLATES_KEY).find(t => t.id === templateId);
                if (template) {
                    populateForm(template);
                    currentPostId = null;
                    currentPostName = 'New Post';
                    updateUIForState();
                    closeModal(modals.templates);
                    showToast(`Loaded template: ${template.name}`, 'success');
                }
            });
        }

        function deleteTemplate(templateId, templateName) {
            showConfirmation(`Are you sure you want to delete the template "${templateName}"?`, () => {
                const templates = getFromStorage(TEMPLATES_KEY).filter(t => t.id !== templateId);
                saveToStorage(TEMPLATES_KEY, templates);
                showToast(`Template "${templateName}" deleted.`, 'success');
                openTemplatesModal();
            });
        }

        // --- Version History Functions ---
        function saveVersion(postId, postData) {
            const versions = getFromStorage(VERSIONS_PREFIX + postId);
            versions.unshift({ versionId: crypto.randomUUID(), savedAt: new Date().toISOString(), data: postData });
            if (versions.length > 10) versions.pop();
            saveToStorage(VERSIONS_PREFIX + postId, versions);
        }

        function openHistoryModal(postId) {
            const versions = getFromStorage(VERSIONS_PREFIX + postId);
            lists.history.innerHTML = '';
            modals.history.querySelector('h2').textContent = `History for ${getFromStorage(LOCAL_STORAGE_KEY).find(p=>p.id===postId)?.name || 'Post'}`;

            if (versions.length === 0) {
                lists.history.innerHTML = '<p class="text-secondary">No previous versions found.</p>';
            } else {
                versions.forEach(version => {
                    const el = document.createElement('div');
                    el.className = 'modal-list-item';
                    el.innerHTML = `<div class="modal-list-item-text">Version from ${new Date(version.savedAt).toLocaleString()}</div><div class="modal-list-item-controls"><button class="action-btn text-sm bg-blue-500 text-white px-2 py-1 rounded" data-post-id="${postId}" data-version-id="${version.versionId}">Restore</button></div>`;
                    lists.history.appendChild(el);
                });
            }
            lists.history.addEventListener('click', (evt) => {
                if(evt.target.dataset.versionId) {
                    restoreVersion(evt.target.dataset.postId, evt.target.dataset.versionId);
                }
            }, { once: true });
            openModal(modals.history);
        }

        function restoreVersion(postId, versionId) {
            showConfirmation("Restoring this version will overwrite the current post content. Continue?", () => {
                const versions = getFromStorage(VERSIONS_PREFIX + postId);
                const versionToRestore = versions.find(v => v.versionId === versionId);
                if (versionToRestore) {
                    populateForm(versionToRestore.data);
                    closeModal(modals.history);
                    showToast("Version restored successfully.", 'success');
                } else {
                    showToast("Could not find version to restore.", 'error');
                }
            });
        }

        // --- Gemini AI Functions ---
        async function handleAIAssist(type, element) {
            const button = buttons[type === 'summarize' ? 'summarizeBackground' : type === 'expand' ? 'expandReports' : 'suggestHashtags'];
            let prompt = '';
            let content = '';

            button.classList.add('loading');
            button.disabled = true;

            try {
                switch (type) {
                    case 'summarize':
                        content = element.value;
                        if (!content) { showToast('Nothing to summarize.', 'error'); return; }
                        prompt = `Summarize the following text for a social media alert post. Be concise and informative:\n\n${content}`;
                        break;
                    case 'expand':
                        content = element.value;
                        if (!content) { showToast('Nothing to expand.', 'error'); return; }
                        prompt = `Expand on the following points, writing them out in a narrative or descriptive paragraph suitable for a social media alert post:\n\n${content}`;
                        break;
                    case 'hashtags':
                        content = generatePostText();
                        if (!content) { showToast('Please write some content before suggesting hashtags.', 'error'); return; }
                        prompt = `Based on the following social media post content, generate a list of 5-10 relevant and effective hashtags. Return them as a single line, separated by spaces, starting with '#'.\n\nPost Content:\n${content}`;
                        break;
                }

                const result = await callGeminiAPI(prompt);
                element.value = result;
                element.dispatchEvent(new Event('input', { bubbles: true }));
                showToast('AI assistance complete!', 'success');

            } catch (error) {
                console.error('Gemini API Error:', error);
                showToast('AI assistance failed. Please try again.', 'error');
            } finally {
                button.classList.remove('loading');
                button.disabled = false;
            }
        }

        async function callGeminiAPI(prompt) {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }]
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(`API request failed with status ${response.status}: ${errorBody.error.message}`);
            }

            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                return result.candidates[0].content.parts[0].text.trim();
            } else {
                throw new Error('Invalid response structure from API.');
            }
        }

        // --- Export Functions ---
        function downloadFile(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportAsTxt() {
            const text = generatePostText(false).replace(/\[(.*?)\]\((.*?)\)/g, '$1: $2'); // Convert links to plain text
            downloadFile(`${currentPostName || 'post'}.txt`, text, 'text/plain;charset=utf-8;');
        }

        function exportAsMd() {
            const text = generatePostText(false);
            downloadFile(`${currentPostName || 'post'}.md`, text, 'text/markdown;charset=utf-8;');
        }

        function exportAsPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const source = document.getElementById('preview');
            doc.html(source, {
                callback: function (doc) {
                    doc.save(`${currentPostName || 'post'}.pdf`);
                },
                x: 10,
                y: 10,
                width: 180,
                windowWidth: 800
            });
        }

        // --- Toast & Modal Helpers ---
        function showToast(message, type = 'success') { const toastContainer = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = message; toastContainer.appendChild(toast); setTimeout(() => { toast.classList.add('show'); }, 10); setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 4000); }
        
        function showConfirmation(message, onConfirm, onCancel) {
            document.getElementById('confirmModalText').textContent = message;
            _confirmCallbacks = { onConfirm, onCancel };
            openModal(modals.confirm);
        }

        function openModal(modalElement) {
            modalElement.style.display = 'flex';
            appContainer.setAttribute('aria-hidden', 'true');
            const focusableElement = modalElement.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (focusableElement) focusableElement.focus();
        }

        function closeModal(modalElement) {
            modalElement.style.display = 'none';
            appContainer.removeAttribute('aria-hidden');
            if (modalElement === modals.confirm) {
                _confirmCallbacks = { onConfirm: null, onCancel: null };
            }
        }
        
        function updateUIForState() {
            if (localStorage.getItem(AUTOSAVE_KEY)) return;

            clearInterval(autosaveInterval);
            if (currentPostId) {
                editingStatus.textContent = `Editing: ${currentPostName}`;
                buttons.saveOrUpdate.textContent = 'Update';
                buttons.saveOrUpdate.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                buttons.saveOrUpdate.classList.add('bg-purple-600', 'hover:bg-purple-700');
            } else {
                editingStatus.textContent = '';
                buttons.saveOrUpdate.textContent = 'Save New';
                buttons.saveOrUpdate.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                buttons.saveOrUpdate.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }
        }

        // --- Initial Load ---
        function initialize() {
            const savedTheme = localStorage.getItem(THEME_KEY);
            if (savedTheme === 'dark') {
                themeToggle.checked = true;
                document.documentElement.classList.add('dark');
            } else {
                themeToggle.checked = false;
                document.documentElement.classList.remove('dark');
            }

            if (getFromStorage(TEMPLATES_KEY).length === 0) {
                const defaultTemplates = [
                    { id: 'template-animal-cruelty', name: 'Animal Cruelty Case', individuals: [{}], investigations: [{}], articles: [{}] },
                    { id: 'template-scam-alert', name: 'Scam/Fraud Alert', individuals: [{}], aliases: [{}], organizations: [{}], fraudulentSolicitations: [{}] },
                    { id: 'template-community-warning', name: 'General Community Warning', individuals: [{}], warningsAndAccounts: [{}] }
                ];
                const fullTemplates = defaultTemplates.map(t => {
                    const base = getFormData(true);
                    base.id = t.id;
                    base.name = t.name;
                    Object.keys(t).forEach(key => {
                        if(Array.isArray(t[key])) base[key] = t[key];
                    });
                    return base;
                });
                saveToStorage(TEMPLATES_KEY, fullTemplates);
            }

            loadAutosavedDraft();
        }
        
        initialize();
    });
    </script>
</body>
</html>

